<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Fingerprint Login Demo</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        input { padding: 15px; width: 300px; font-size: 18px; border-radius: 10px; border: none; margin: 10px; }
        button { padding: 15px 30px; font-size: 18px; border-radius: 10px; border: none; cursor: pointer; margin: 10px; background: white; color: #667eea; font-weight: bold; }
        button:hover { transform: scale(1.05); }
        #status { margin-top: 20px; font-size: 16px; }
        .demo-note { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; margin: 20px; }
    </style>
</head>
<body>
    <h1>?? Real Fingerprint Login (WebAuthn Demo)</h1>
    <p>Enter username below, then register/login. Your device will prompt for fingerprint!</p>
    <div class="demo-note">
        <strong>Note:</strong> This uses your device's real biometric (fingerprint/Face ID). Tested on Chrome/Edge. If no prompt, enable biometrics in your OS settings.
    </div>
    <input type="text" id="username" placeholder="Enter username (e.g., testuser)" />
    <br>
    <button onclick="handleRegister()">Register with Fingerprint</button>
    <button onclick="handleLogin()">Login with Fingerprint</button>
    <div id="status"></div>

    <script>
        // Simple in-memory storage for demo (no server)
        const users = {};
        let currentChallenge = null;

        // Generate random challenge (simulates server)
        function generateChallenge() {
            return new Uint8Array(32);
        }

        // Convert ArrayBuffer to Base64 for demo
        function ab2str(buf) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buf)));
        }

        // Simulate server registration
        async function simulateRegister(username, credential) {
            if (!users[username]) users[username] = { credentials: [] };
            users[username].credentials.push({
                id: credential.id,
                publicKey: credential.response.attestationObject, // Simplified
                counter: 0
            });
            return { success: true };
        }

        // Simulate server login
        async function simulateLogin(username, assertion) {
            const user = users[username];
            if (!user || user.credentials.length === 0) return { success: false, error: 'Not registered' };
            // Simple verification (in real app, verify signature)
            return { success: true, message: 'Logged in with fingerprint!' };
        }

        async function handleRegister() {
            const username = document.getElementById('username').value.trim();
            if (!username) return updateStatus('Enter a username!', 'error');

            try {
                updateStatus('Requesting registration challenge...', 'info');

                // Generate challenge (from "server")
                const challenge = generateChallenge();
                currentChallenge = ab2str(challenge);

                // WebAuthn registration options (forces platform biometric)
                const publicKey = {
                    challenge: challenge,
                    rp: { name: 'Fingerprint Demo' },
                    user: {
                        id: new TextEncoder().encode(username),
                        name: username,
                        displayName: username
                    },
                    pubKeyCredParams: [{ alg: -7, type: 'public-key' }],
                    authenticatorSelection: {
                        authenticatorAttachment: 'platform', // Built-in fingerprint/Face ID
                        userVerification: 'required' // Must use biometric
                    },
                    timeout: 60000,
                    extensions: { credProps: true }
                };

                updateStatus('Touch your fingerprint sensor now...', 'info');
                const credential = await navigator.credentials.create({ publicKey });

                updateStatus('Verifying with server...', 'info');

                // Simulate server verification
                const result = await simulateRegister(username, credential);
                if (result.success) {
                    updateStatus('Fingerprint registered successfully! ??', 'success');
                } else {
                    updateStatus('Registration failed', 'error');
                }
            } catch (err) {
                updateStatus(`Error: ${err.message} (Make sure biometrics are enabled)`, 'error');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) return updateStatus('Enter a username!', 'error');

            try {
                updateStatus('Requesting login challenge...', 'info');

                // Generate challenge
                const challenge = generateChallenge();
                currentChallenge = ab2str(challenge);

                const publicKey = {
                    challenge: challenge,
                    allowCredentials: users[username]?.credentials?.map(cred => ({
                        type: 'public-key',
                        id: new TextEncoder().encode(cred.id)
                    })) || [],
                    userVerification: 'required',
                    timeout: 60000
                };

                updateStatus('Touch your fingerprint sensor now...', 'info');
                const assertion = await navigator.credentials.get({ publicKey });

                updateStatus('Verifying login...', 'info');

                // Simulate server verification
                const result = await simulateLogin(username, assertion);
                if (result.success) {
                    updateStatus(`${result.message} ?`, 'success');
                } else {
                    updateStatus(result.error, 'error');
                }
            } catch (err) {
                updateStatus(`Login failed: ${err.message}`, 'error');
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'yellow';
        }

        // Check WebAuthn support
        if (!window.PublicKeyCredential) {
            updateStatus('Your browser doesn\'t support WebAuthn. Use Chrome/Edge/Firefox.', 'error');
        }
    </script>
</body>
</html>
